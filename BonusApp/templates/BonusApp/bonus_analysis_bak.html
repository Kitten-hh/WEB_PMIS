{% extends 'BaseApp/keen_base/base_form1/base.html' %}

{% load static %}

{%block form_css%}
<script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<style>
    #simple_datatable {
        width: 100% !important;
        margin-bottom: 5rem;
    }

    #simple_datatable thead tr th:nth-child(10) {
        display: none;
    }

    #simple_datatable tbody tr td:nth-child(10) {
        display: none;
    }

    .fa-chevron-right:hover {
        color: orange;
    }

    .client_span {
        width: 2rem;
        height: 2rem;
        background: orange;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    #simple_datatable tbody tr:hover {
        background-color: #F3F3F3;
    }


    .hide_Contact tbody tr td:nth-child(1) {
        display: none;

    }

    .hide_Contact thead tr th:nth-child(1) {
        display: none;
    }

    .hide_taskType tbody tr td:nth-child(4) {
        display: none;
    }

    .hide_taskType thead tr th:nth-child(4) {
        display: none;
    }

    .change_color tbody tr:nth-child(odd) {
        background-color: #F3F3F3;
    }

    .group td div {
        display: flex;
        justify-content: space-between;
    }

    .group {
        font-size: 1.4rem;
        font-weight: bold;
    }

    .Add_TaskType {
        position: fixed;
        right: 5%;
        bottom: 10%;
    }

    .Add_TaskType div {
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
        background-color: orange;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .Add_TaskType div i {
        font-size: 2rem;
        color: white;
    }

    /* 搜索框 */
    .scrollable-menu {
        height: auto;
        display: inline-block;
        max-height: 200px;
        overflow-x: hidden;
    }

    #task_search_box {
        width: 20%;
        line-height: 10px;
        margin-right: 70%;
        margin-top: -6px;
    }

    .content {
        padding: 0px 0;
    }

    .modal-backdrop {
        z-index: 9;
    }

    #TaskType {
        height: 39px;
        /* top: 0.2rem; */
        /* position: absolute; */
        /* top: 50%;
        transform: translateY(-50%); */
        line-height: 10px;
    }

    .datefiler {
        margin-left: 6%;
    }

    #simple_datatable_wrapper {
        margin-top: 20px
    }

    #serBox {
        display: inline-block;
        height: 40px;
    }

    .bar {
        position: relative;
        margin-top: -39px;
        margin-left: 500px;
    }

    /* .bartype{
        display: inline-block;
    } */
</style>
{%endblock%}


{% block content %}

<div id="app">
    <div class="card card-custom ml-2 mr-2 mt-2">
        <div class="card-body no-drag grid-item-body">
            <div class="boxtype">
                <div class="container-fluid d-flex align-items-stretch justify-content-between " id="serBox">
                    <!-- 模態框按鈕 -->
                    <button class="nav-link btn btn-primary" id="TaskType" data-toggle="modal" data-target="#myModal">
                        <!-- href="javascript:void(0)" -->
                        統計Bonus
                        <!-- <i class="fa fa-search-plus" aria-hidden="true"></i> -->
                    </button>
                    <!-- 模態框 -->
                    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title" id="myModalLabel">
                                        查询
                                    </h4>
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                        &times;
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <form class="form-horizontal" role="form">
                                        <div class="form-group">
                                            <label for="contact" class="col-sm-9 control-label">联系人:</label>
                                            <div class="col-sm-9">
                                                <input type="text" class="form-control" id="contact" name="contact"
                                                    placeholder="联系人">
                                            </div>
                                        </div>
                                        <div class="form-group ">
                                            <div class="row">
                                                <div class='col-sm-6'>
                                                    <div class="form-group datefiler">
                                                        <label>從實際結束時間：</label>
                                                        <!--指定 date标记-->
                                                        <div class='input-group date' id='datetimepicker1'>
                                                            <input type='date' class="form-control" id="edatefrom" />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class='col-sm-6'>
                                                    <div class="form-group">
                                                        <label>到實際結束時間：</label>
                                                        <!-- 指定 date标记 -->
                                                        <div class='input-group date' id='datetimepicker2'>
                                                            <input type='date' class="form-control" id="edateto" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">關閉
                                    </button>
                                    <button type="button" class="btn btn-primary" id="searchdate">
                                        計算Bonus
                                    </button>
                                </div>
                            </div><!-- /.modal-content -->
                        </div><!-- /.modal -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card card-custom ml-2 mr-2 mt-2">
        <div class="card-body no-drag grid-item-body">
            <label class="col-form-label text-lg-right">Budget Allowance %:</label>
            <label class="col-form-label text-lg-right ml-2" id="BudgetAllowance"></label>
            <label class="col-form-label text-lg-right ml-6">Perfect Scoring:</label>
            <label class="col-form-label text-lg-right ml-2" id="PerfectScoring"></label>
            <label class="col-form-label text-lg-right ml-6">Ratio Of M:</label>
            <label class="col-form-label text-lg-right ml-2" id="RatioOFM"></label>
            <label class="col-form-label text-lg-right ml-6">Ratio Of S:</label>
            <label class="col-form-label text-lg-right ml-2" id="RatioOFS"></label>
            <label class="col-form-label text-lg-right ml-6">Ratio Of P:</label>
            <label class="col-form-label text-lg-right ml-2" id="RatioOFP"></label>

            <label class="col-form-label text-lg-right ml-6">Management S:</label>
            <label class="col-form-label text-lg-right ml-2" id="ManagementS"></label>
            <label class="col-form-label text-lg-right ml-6">Performance. S:</label>
            <label class="col-form-label text-lg-right ml-2" id="PerformanceS"></label>
            <label class="col-form-label text-lg-right ml-6">Quarter Working Day:</label>
            <label class="col-form-label text-lg-right ml-2" id="QuarterWorkingDay"></label>
            <label class="col-form-label text-lg-right ml-6">Working Day:</label>
            <label class="col-form-label text-lg-right ml-2" id="WorkingDay"></label>
            <label class="col-form-label text-lg-right ml-6">Mag %:</label>
            <label class="col-form-label text-lg-right ml-2" id="ManagementRatio"></label>
            <label class="col-form-label text-lg-right ml-6">Per %:</label>
            <label class="col-form-label text-lg-right ml-2" id="PerformanaceRatio"></label>
            <label class="col-form-label text-lg-right ml-6">Salary $:</label>
            <label class="col-form-label text-lg-right ml-2" id="Salary"></label>
        </div>
    </div>
    <div class="card card-custom ml-2 mr-2 mt-2">
        <div class="card-body no-drag grid-item-body">
            <label class="col-form-label text-lg-right">Total Score:</label>
            <label class="col-form-label text-lg-right ml-2" style="color:blue;" id="Score"></label>
            <label class="col-form-label text-lg-right ml-2" style="color:red;" id="LookupScore"></label>
            <label class="col-form-label text-lg-right ml-6">Avg:</label>
            <label class="col-form-label text-lg-right ml-2" id="ScoreAvg"></label>
            <label class="col-form-label text-lg-right ml-6">Sugg.Avg:</label>
            <label class="col-form-label text-lg-right ml-2" id="SuggAvg"></label>
            <label class="col-form-label text-lg-right ml-6">S Score for the quarter.S:</label>
            <label class="col-form-label text-lg-right ml-2" style="color:blue;" id="QuarterScore"></label>
            <label class="col-form-label text-lg-right ml-2" style="color:red;"  id="QuarterLookupScore"></label>
    
            <label class="col-form-label text-lg-right ml-6">Simulate Score:</label>
            <label class="col-form-label text-lg-right ml-2" id="SimulateScore"></label>
            <label class="col-form-label text-lg-right ml-6">S Bonus:</label>
            <label class="col-form-label text-lg-right ml-2" style="color:blue;" id="ScoreBonus"></label>
            <label class="col-form-label text-lg-right ml-2" style="color:red;"  id="LookupScoreBonus"></label>
            <label class="col-form-label text-lg-right ml-6">Simulate $per mth:</label>
            <label class="col-form-label text-lg-right ml-2" id="SimulatePerMth"></label>
            <label class="col-form-label text-lg-right ml-6">S Actual Quarter:</label>
            <label class="col-form-label text-lg-right ml-2" style="color:blue;" id="ScoreActualQuarter"></label>
            <label class="col-form-label text-lg-right ml-2" style="color:red;"  id="LookupScoreActualQuarter"></label>
            <label class="col-form-label text-lg-right ml-6">Act in $ per mth:</label>
            <label class="col-form-label text-lg-right ml-2" id="ActInPerMth"></label>
    
        </div>
    </div>
    <div class="card card-custom ml-2 mr-2 mt-2">
        <div class="card-body no-drag grid-item-body">
            <div class="boxtype">
                <div class="container-fluid d-flex align-items-stretch justify-content-between ">
                    <table id="simple_datatable" class="table table-striped- table-hover">
                        <thead>
                            <tr>
                                <th style="width: 6%;">Contact</th>
                                <th>TaskNo</th>
                                <th style="width: 20%;">Task Description</th>
                                <th>Task Type</th>
                                <th>TaskType Description</th>
                                <th>Sub TaskType Description</th>
                                <th>Date</th>
                                <th>Score</th>
                                <th>Lookup Score</th>
                                <th>inc_id</th>                                
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>    

</div>
{% endblock %}



{%block form_js%}
<script src="{% static 'BonusApp/vendor/vendor/jquery/jquery.min.js'%}"></script>
<!-- 必须在bootstap之前引入 -->
<script src="{% static 'BonusApp/vendor/vendor/popper.js/umd/popper.min.js'%}"></script>
<script src="{% static 'BonusApp/vendor/vendor/bootstrap/js/bootstrap.min.js'%}"></script>
<script src="{% static 'BonusApp/vendor/javascript/theme.min.js'%}"></script>
<script src="{% static 'BonusApp/vendor/vendor/stacked-menu/js/stacked-menu.min.js'%}"></script>
<!-- Vue -->
<script src="{% static 'BaseProject/vendor/Vue/vue.js' %}"></script>
<script src="{% static 'BaseProject/vendor/Vue/vue-super.js' %}"></script>
<!-- datatables -->
<script src="{% static 'BaseProject/vendor/datatables-1.10.20/datatables.min.js' %}" type="text/javascript"></script>
<script type="text/javascript" src="{% static 'BonusApp/js/loadmenu.js' %}"></script>
<script type="text/javascript" src="{% static 'BonusApp/tools/tool.js' %}"></script>
<script>
    $(function () {
        $("#kt_footer").remove();
        $("#searchdate").on('click', function () {

            var contact = $("#contact").val();
            var edateOne = $("#edateOne").val();
            var edateTwo = $("#edateTwo").val();
            if (contact == '') {
                alert("請輸入聯繫人");
                return;
            }
            if (edateOne == '' || edateTwo == '') {
                alert("請選擇時間範圍");
                return;
            }
            /*
            if ($('.fade').css('display') == "none") {
                $('.fade').show();
            } else {
                $('.fade').hide();
            }*/
            //$("#myModal").modal('hide');
            $('.fade').hide();
            $.ajax({
                url: "/bonus/bonus_analysis",
                data: { 'contact': contact, 'edateOne': edateOne, 'edateTwo': edateTwo },
                type: 'GET',
                dataType: 'json',
                cache: false,
                success: function (result) {
                    message = result.errorMessage;
                    if (message != ''){
                        alert(message);
                        return;
                    }
                    var table_data = result.data;
                    showBonusResult(result.bonusResult);                
                    table = $("#simple_datatable").DataTable({
                        dom: `Z<'row'<'col-sm-12'tr>>`,
                        serverSide: false,
                        scrollX: false,
                        responsive: true,
                        ordering: false,
                        data: table_data,
                        destroy: true,
                        paging: false,
                        columns: [
                            { name: "contact", data: "contact" },
                            { name: "taskno", data: "taskno" },
                            { name: "task", data: "task" },
                            { name: "realtasktype", data: "realtasktype" },
                            { name: "tasktypedesc", data: "tasktypedesc" },
                            { name: "subtasktypedesc", data: "subtasktypedesc" },
                            {
                                data: "edate", //字段名稱
                                //定義要處理的日期函數                              
                                render: function ChangeDateFormat(value) {
                                    var reg = /^\s*$/;
                                    //返回值为true表示不是空字符串
                                    if (value != null && value != undefined && !reg.test(value)) {
                                        var datepromised = new Date(value);
                                        var month = datepromised.getMonth() + 1;
                                        var day = datepromised.getDate();
                                        month = (month.toString().length == 1) ? ("0" + month) : month;
                                        day = (day.toString().length == 1) ? ("0" + day) : day;
                                        //当前日期 yyyy-MM-dd
                                        return datepromised.getFullYear() + '-' + month + '-' + day;
                                    } else
                                        return '';
                                }
                            },
                            { name: "score", data: "score" },
                            { name: "lookupscore", data: "lookupscore" },
                            { name: "inc_id", data: "inc_id" },
                            /*
                            {
                                data: null,
                                "mRender": function (data, type, row, setting) {
                                    return `<i class="fa fa-chevron-right"></i>`;
                                }
                            },*/

                        ],

                    })

                },
                fail: function (data) {
                    $("#simple_datatable").html("");
                }
            })
        })

        //顯示Bonus的計算結果
        function showBonusResult(data){
            $("#BudgetAllowance").html(data["BudgetAllowance"]);
            $("#PerfectScoring").html(data["PerfectScoring"]);            
            $("#RatioOFM").html(data["RatioOFM"]);
            $("#RatioOFS").html(data["RatioOFS"]);
            $("#RatioOFP").html(data["RatioOFP"]);
            $("#ManagementS").html(data["ManagementS"]);
            $("#PerformanceS").html(data["PerformanceS"]);
            $("#QuarterWorkingDay").html(data["QuarterWorkingDay"]);
            $("#WorkingDay").html(data["WorkingDay"]);
            $("#ManagementRatio").html(data["ManagementRatio"]);
            $("#PerformanaceRatio").html(data["PerformanaceRatio"]);
            $("#Salary").html(data["Salary"]);

            $("#Score").html(data["Score"]);
            $("#LookupScore").html(data["LookupScore"]);
            $("#ScoreAvg").html(data["ScoreAvg"]);
            $("#SuggAvg").html(data["SuggAvg"]);
            $("#QuarterScore").html(data["QuarterScore"]);
            $("#QuarterLookupScore").html(data["QuarterLookupScore"]);
            $("#SimulateScore").html(data["SimulateScore"]);
            $("#ScoreBonus").html(data["ScoreBonus"]);
            $("#LookupScoreBonus").html(data["LookupScoreBonus"]);
            $("#SimulatePerMth").html(data["SimulatePerMth"]);
            $("#ScoreActualQuarter").html(data["ScoreActualQuarter"]);
            $("#LookupScoreActualQuarter").html(data["LookupScoreActualQuarter"]);
            $("#ActInPerMth").html(data["ActInPerMth"]);
        }
    });   
</script>
{% endblock %}